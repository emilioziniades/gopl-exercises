<!DOCTYPE html><html lang="en"><head>

<link rel="preconnect" href="https://www.googletagmanager.com"/>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-W8MVQXG');</script>
  
<meta charset="utf-8"/>
<meta name="description" content="Go is an open source programming language that makes it easy to build simple, reliable, and efficient software."/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#00add8"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:400,500,600|Work+Sans:400,500,600|Roboto:400,500,700|Open+Sans:Source+Code+Pro|Material+Icons"/>
<link rel="stylesheet" href="/css/styles.css"/>

<link rel="stylesheet" href="/css/blogfonts.css"/>
<link rel="alternate" title="The Go Blog" type="application/atom+xml" href="/blog/feed.atom"/>

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-W8MVQXG');</script>
  
<script src="/js/site.js"></script>
<title>The Go image/draw package - The Go Programming Language</title>
</head>
<body class="Site">
  
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W8MVQXG"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  


<header class="Site-header js-siteHeader">
  <div class="Header Header--dark">
    <nav class="Header-nav">
      <a href=".///index.html">
        <img class="js-headerLogo Header-logo" src="/images/go-logo-white.svg" alt="Go"/>
      </a>
      <div class="Header-rightContent">
        <ul class="Header-menu">
          <li class="Header-menuItem ">
            <a href=".//solutions//index.html">Why Go</a>
          </li>
          <li class="Header-menuItem ">
            <a href=".//learn//index.html">Get Started</a>
          </li>
          <li class="Header-menuItem ">
            <a href=".//doc//index.html">Docs</a>
          </li>
          <li class="Header-menuItem ">
            <a href=".//index.html">Packages</a>
          </li>
          <li class="Header-menuItem ">
            <a href=".//play//index.html">Play</a>
          </li>
          <li class="Header-menuItem  Header-menuItem--active">
            <a href=".//blog//index.html">Blog</a>
          </li>
        </ul>
        <button class="Header-navOpen js-headerMenuButton Header-navOpen--white" aria-label="Open navigation.">
        </button>
      </div>
    </nav>
    
  </div>
</header>
<aside class="NavigationDrawer js-header">
  <nav class="NavigationDrawer-nav">
    <div class="NavigationDrawer-header">
      <a href=".///index.html">
        <img class="NavigationDrawer-logo" src="/images/go-logo-blue.svg" alt="Go."/>
      </a>
    </div>
    <ul class="NavigationDrawer-list">
        <li class="NavigationDrawer-listItem ">
          <a href=".//solutions//index.html">Why Go</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href=".//learn//index.html">Get Started</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href=".//doc//index.html">Docs</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href=".//index.html">Packages</a>
        </li>
        <li class="NavigationDrawer-listItem ">
          <a href=".//play//index.html">Play</a>
        </li>
        <li class="NavigationDrawer-listItem  NavigationDrawer-listItem--active">
          <a href=".//blog//index.html">Blog</a>
        </li>
    </ul>
  </nav>
</aside>
<div class="NavigationDrawer-scrim js-scrim" role="presentation"></div>
<main class="SiteContent SiteContent--default">
  
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/image-draw">
    
    <h1 class="small"><a href=".//blog//index.html">The Go Blog</a></h1>
    

    <h1>The Go image/draw package</h1>
      
      <p class="author">
      Nigel Tao<br/>
      29 September 2011
      </p>
      
      <h2 id="introduction">Introduction</h2>
<p><a href=".//pkg/image/draw//index.html">Package image/draw</a> defines only one operation:
drawing a source image onto a destination image,
through an optional mask image.
This one operation is surprisingly versatile and can perform a number of
common image manipulation tasks elegantly and efficiently.</p>
<p>Composition is performed pixel by pixel in the style of the Plan 9 graphics
library and the X Render extension.
The model is based on the classic “Compositing Digital Images” paper by Porter and Duff,
with an additional mask parameter:
<code>dst = (src IN mask) OP dst</code>.
For a fully opaque mask, this reduces to the original Porter-Duff formula: <code>dst = src OP dst</code>.
In Go, a nil mask image is equivalent to an infinitely sized,
fully opaque mask image.</p>
<p>The Porter-Duff paper presented <a href=".//TR/SVGCompositing/examples/compop-porterduff-examples.png/index.html" rel="noreferrer" target="_blank">12 different composition operators</a>,
but with an explicit mask, only 2 of these are needed in practice:
source-over-destination and source.
In Go, these operators are represented by the <code>Over</code> and <code>Src</code> constants.
The <code>Over</code> operator performs the natural layering of a source image over
a destination image:
the change to the destination image is smaller where the source (after masking)
is more transparent (that is, has lower alpha).
The <code>Src</code> operator merely copies the source (after masking) with no regard
for the destination image’s original content.
For fully opaque source and mask images, the two operators produce the same output,
but the <code>Src</code> operator is usually faster.</p>
<h2 id="geometric-alignment">Geometric Alignment</h2>
<p>Composition requires associating destination pixels with source and mask pixels.
Obviously, this requires destination, source and mask images,
and a composition operator, but it also requires specifying what rectangle
of each image to use.
Not every drawing should write to the entire destination:
when updating an animating image, it is more efficient to only draw the
parts of the image that have changed.
Not every drawing should read from the entire source:
when using a sprite that combines many small images into one large one,
only a part of the image is needed.
Not every drawing should read from the entire mask:
a mask image that collects a font’s glyphs is similar to a sprite.
Thus, drawing also needs to know three rectangles, one for each image.
Since each rectangle has the same width and height,
it suffices to pass a destination rectangle <code>r</code> and two points <code>sp</code> and <code>mp</code>:
the source rectangle is equal to <code>r</code> translated so that <code>r.Min</code> in the destination
image aligns with <code>sp</code> in the source image,
and similarly for <code>mp</code>.
The effective rectangle is also clipped to each image’s bounds in their
respective co-ordinate space.</p>
<div class="image">
  <img src="image-draw/20.png" alt=""/>
</div>
<p>The <a href=".//pkg/image/draw//index.html"><code>DrawMask</code></a> function
takes seven arguments,
but an explicit mask and mask-point are usually unnecessary,
so the <a href=".//pkg/image/draw//index.html"><code>Draw</code></a> function takes five:</p>
<pre><code>// Draw calls DrawMask with a nil mask.
func Draw(dst Image, r image.Rectangle, src image.Image, sp image.Point, op Op)
func DrawMask(dst Image, r image.Rectangle, src image.Image, sp image.Point,
 mask image.Image, mp image.Point, op Op)
</code></pre>
<p>The destination image must be mutable, so the image/draw package defines
a <a href=".//pkg/image/draw//index.html"><code>draw.Image</code></a> interface which has a <code>Set</code> method.</p>
<pre><code>type Image interface {
    image.Image
    Set(x, y int, c color.Color)
}
</code></pre>
<h2 id="filling-a-rectangle">Filling a Rectangle</h2>
<p>To fill a rectangle with a solid color, use an <code>image.Uniform</code> source.
The <code>ColorImage</code> type re-interprets a <code>Color</code> as a practically infinite-sized
<code>Image</code> of that color.
For those familiar with the design of Plan 9’s draw library,
there is no need for an explicit “repeat bit” in Go’s slice-based image types;
the concept is subsumed by <code>Uniform</code>.</p>
<pre><code>// image.ZP is the zero point -- the origin.
draw.Draw(dst, r, &amp;image.Uniform{c}, image.ZP, draw.Src)
</code></pre>
<p>To initialize a new image to all-blue:</p>
<pre><code>m := image.NewRGBA(image.Rect(0, 0, 640, 480))
blue := color.RGBA{0, 0, 255, 255}
draw.Draw(m, m.Bounds(), &amp;image.Uniform{blue}, image.ZP, draw.Src)
</code></pre>
<p>To reset an image to transparent (or black,
if the destination image’s color model cannot represent transparency),
use <code>image.Transparent</code>, which is an <code>image.Uniform</code>:</p>
<pre><code>draw.Draw(m, m.Bounds(), image.Transparent, image.ZP, draw.Src)
</code></pre>
<div class="image">
  <img src="image-draw/2a.png" alt=""/>
</div>
<h2 id="copying-an-image">Copying an Image</h2>
<p>To copy from a rectangle <code>sr</code> in the source image to a rectangle starting
at a point <code>dp</code> in the destination,
convert the source rectangle into the destination image’s co-ordinate space:</p>
<pre><code>r := image.Rectangle{dp, dp.Add(sr.Size())}
draw.Draw(dst, r, src, sr.Min, draw.Src)
</code></pre>
<p>Alternatively:</p>
<pre><code>r := sr.Sub(sr.Min).Add(dp)
draw.Draw(dst, r, src, sr.Min, draw.Src)
</code></pre>
<p>To copy the entire source image, use <code>sr = src.Bounds()</code>.</p>
<div class="image">
  <img src="image-draw/2b.png" alt=""/>
</div>
<h2 id="scrolling-an-image">Scrolling an Image</h2>
<p>Scrolling an image is just copying an image to itself,
with different destination and source rectangles.
Overlapping destination and source images are perfectly valid,
just as Go’s built-in copy function can handle overlapping destination and source slices.
To scroll an image m by 20 pixels:</p>
<pre><code>b := m.Bounds()
p := image.Pt(0, 20)
// Note that even though the second argument is b,
// the effective rectangle is smaller due to clipping.
draw.Draw(m, b, m, b.Min.Add(p), draw.Src)
dirtyRect := b.Intersect(image.Rect(b.Min.X, b.Max.Y-20, b.Max.X, b.Max.Y))
</code></pre>
<div class="image">
  <img src="image-draw/2c.png" alt=""/>
</div>
<h2 id="converting-an-image-to-rgba">Converting an Image to RGBA</h2>
<p>The result of decoding an image format might not be an <code>image.RGBA</code>:
decoding a GIF results in an <code>image.Paletted</code>,
decoding a JPEG results in a <code>ycbcr.YCbCr</code>,
and the result of decoding a PNG depends on the image data.
To convert any image to an <code>image.RGBA</code>:</p>
<pre><code>b := src.Bounds()
m := image.NewRGBA(image.Rect(0, 0, b.Dx(), b.Dy()))
draw.Draw(m, m.Bounds(), src, b.Min, draw.Src)
</code></pre>
<div class="image">
  <img src="image-draw/2d.png" alt=""/>
</div>
<h2 id="drawing-through-a-mask">Drawing Through a Mask</h2>
<p>To draw an image through a circular mask with center <code>p</code> and radius <code>r</code>:</p>
<pre><code>type circle struct {
    p image.Point
    r int
}

func (c *circle) ColorModel() color.Model {
    return color.AlphaModel
}

func (c *circle) Bounds() image.Rectangle {
    return image.Rect(c.p.X-c.r, c.p.Y-c.r, c.p.X+c.r, c.p.Y+c.r)
}

func (c *circle) At(x, y int) color.Color {
    xx, yy, rr := float64(x-c.p.X)+0.5, float64(y-c.p.Y)+0.5, float64(c.r)
    if xx*xx+yy*yy &lt; rr*rr {
        return color.Alpha{255}
    }
    return color.Alpha{0}
}

    draw.DrawMask(dst, dst.Bounds(), src, image.ZP, &amp;circle{p, r}, image.ZP, draw.Over)
</code></pre>
<div class="image">
  <img src="image-draw/2e.png" alt=""/>
</div>
<h2 id="drawing-font-glyphs">Drawing Font Glyphs</h2>
<p>To draw a font glyph in blue starting from a point <code>p</code>,
draw with an <code>image.ColorImage</code> source and an <code>image.Alpha mask</code>.
For simplicity, we aren’t performing any sub-pixel positioning or rendering,
or correcting for a font’s height above a baseline.</p>
<pre><code>src := &amp;image.Uniform{color.RGBA{0, 0, 255, 255}}
mask := theGlyphImageForAFont()
mr := theBoundsFor(glyphIndex)
draw.DrawMask(dst, mr.Sub(mr.Min).Add(p), src, image.ZP, mask, mr.Min, draw.Over)
</code></pre>
<div class="image">
  <img src="image-draw/2f.png" alt=""/>
</div>
<h2 id="performance">Performance</h2>
<p>The image/draw package implementation demonstrates how to provide an image
manipulation function that is both general purpose,
yet efficient for common cases.
The <code>DrawMask</code> function takes arguments of interface types,
but immediately makes type assertions that its arguments are of specific struct types,
corresponding to common operations like drawing one <code>image.RGBA</code> image onto another,
or drawing an <code>image.Alpha</code> mask (such as a font glyph) onto an <code>image.RGBA</code> image.
If a type assertion succeeds, that type information is used to run a specialized
implementation of the general algorithm.
If the assertions fail, the fallback code path uses the generic <code>At</code> and <code>Set</code> methods.
The fast-paths are purely a performance optimization;
the resultant destination image is the same either way.
In practice, only a small number of special cases are necessary to support
typical applications.</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href=".//blog/tour/index.html">Learn Go from your browser</a><br/>
          
        
        
          
            <b>Previous article: </b><a href=".//blog/image/index.html">The Go image package</a><br/>
          
        
        <b><a href=".//blog/all/index.html">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </p></div>
    

  </div>
</div>

<script src="/js/jquery.js"></script>
<script src="/js/playground.js"></script>
<script src="/js/play.js"></script>
<script src="/js/godocs.js"></script>

</div></main>
<footer class="Site-footer">
  <div class="Footer">
    <div class="Container">
      <div class="Footer-links">
          <div class="Footer-linkColumn">
            <a href=".//solutions//index.html" class="Footer-link Footer-link--primary">
              Why Go
            </a>
              <a href=".//solutions//index.html" class="Footer-link">
                Use Cases
              </a>
              <a href=".//solutions//index.html" class="Footer-link">
                Case Studies
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href=".//learn//index.html" class="Footer-link Footer-link--primary">
              Get Started
            </a>
              <a href=".//play/index.html" class="Footer-link">
                Playground
              </a>
              <a href=".//tour//index.html" class="Footer-link">
                Tour
              </a>
              <a href=".//questions/tagged/go/index.html" class="Footer-link">
                Stack Overflow
              </a>
              <a href=".//help//index.html" class="Footer-link">
                Help
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href=".//index.html" class="Footer-link Footer-link--primary">
              Packages
            </a>
              <a href=".//pkg//index.html" class="Footer-link">
                Standard Library
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href=".//project/index.html" class="Footer-link Footer-link--primary">
              About
            </a>
              <a href=".//dl//index.html" class="Footer-link">
                Download
              </a>
              <a href=".//blog//index.html" class="Footer-link">
                Blog
              </a>
              <a href=".//golang/go/issues/index.html" class="Footer-link">
                Issue Tracker
              </a>
              <a href=".//doc/devel/release/index.html" class="Footer-link">
                Release Notes
              </a>
              <a href=".//go-brand/index.html" class="Footer-link">
                Brand Guidelines
              </a>
              <a href=".//conduct/index.html" class="Footer-link">
                Code of Conduct
              </a>
          </div>
          <div class="Footer-linkColumn">
            <a href=".//golang/index.html" class="Footer-link Footer-link--primary">
              Connect
            </a>
              <a href=".//golang/index.html" class="Footer-link">
                Twitter
              </a>
              <a href=".//golang/index.html" class="Footer-link">
                GitHub
              </a>
              <a href=".///index.html" class="Footer-link">
                Slack
              </a>
              <a href=".//r/golang/index.html" class="Footer-link">
                r/golang
              </a>
              <a href=".//pro/go/index.html" class="Footer-link">
                Meetup
              </a>
              <a href=".///index.html" class="Footer-link">
                Golang Weekly
              </a>
          </div>
      </div>
    </div>
  </div>
  <div class="Footer">
    <div class="Container Container--fullBleed">
      <div class="Footer-bottom">
        <img class="Footer-gopher" src="/images/gophers/pilot-bust.svg" alt="The Go Gopher"/>
        <ul class="Footer-listRow">
          <li class="Footer-listItem">
            <a href=".//copyright/index.html">Copyright</a>
          </li>
          <li class="Footer-listItem">
            <a href=".//tos/index.html">Terms of Service</a>
          </li>
          <li class="Footer-listItem">
            <a href=".//intl/en/policies/privacy//index.html" target="_blank" rel="noopener">
              Privacy Policy
            </a>
            </li>
          <li class="Footer-listItem">
            <a href=".//s/website-issue/index.html" target="_blank" rel="noopener">
              Report an Issue
            </a>
          </li>
        </ul>
        <a class="Footer-googleLogo" target="_blank" href=".//index.html" rel="noopener">
          <img class="Footer-googleLogoImg" src="/images/google-white.png" alt="Google logo"/>
        </a>
      </div>
    </div>
  </div>
  <script src="/js/jquery.js"></script>
  <script src="/js/carousels.js"></script>
  <script src="/js/searchBox.js"></script>
  <script src="/js/misc.js"></script>
  <script src="/js/hats.js"></script>
  <script src="/js/playground.js"></script>
  <script src="/js/godocs.js"></script>
</footer>
















</body></html>